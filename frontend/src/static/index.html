<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>React Login</title>
    <!-- Load React and ReactDOM UMD builds from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; }
      .error { color: #b00020; }
      label { display:block; margin:8px 0; }
      input { padding:6px; width: 300px; }
      button { padding:8px 12px; margin-top:8px }
      pre { background:#f6f8fa; padding:10px; max-width:800px }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script>
      (function(){
        const e = React.createElement;
        const { useState } = React;

        function validateEmail(email){
          return /\S+@\S+\.\S+/.test(email);
        }

        function LoginApp(){
          const [username, setUsername] = useState('');
          const [password, setPassword] = useState('');
          const [errors, setErrors] = useState({});
          const [out, setOut] = useState('');
          const [loading, setLoading] = useState(false);

          function validate(){
            const errs = {};
            if(!username || username.trim() === '') errs.username = 'Username or email is required';
            else if(username.includes('@') && !validateEmail(username)) errs.username = 'Invalid email format';
            if(!password || password.length < 6) errs.password = 'Password must be at least 6 characters';
            setErrors(errs);
            return Object.keys(errs).length === 0;
          }

          async function onSubmit(eEvent){
            eEvent.preventDefault();
            setOut('');
            if(!validate()) return;
            setLoading(true);
            try{
              const resp = await fetch('http://localhost:3001/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
              });
              const data = await resp.json();
              setOut(JSON.stringify(data, null, 2));
              if(data.token){
                localStorage.setItem('token', data.token);
              }
            }catch(err){
              setOut('Network error: ' + String(err));
            }finally{ setLoading(false); }
          }

          async function showProfile(){
            const token = localStorage.getItem('token');
            if(!token){ setOut('No token stored. Login first.'); return; }
            try{
              const resp = await fetch('http://localhost:3001/profile', { headers: { 'x-auth-token': token } });
              const data = await resp.json();
              setOut(JSON.stringify(data, null, 2));
            }catch(err){ setOut('Network error: ' + String(err)); }
          }

          return e('div', null,
            e('h1', null, 'Login'),
            e('form', { onSubmit },
              e('label', null, 'Username or Email',
                e('input', { value: username, onChange: (ev)=>setUsername(ev.target.value), placeholder: 'username or email' })
              ),
              errors.username ? e('div', { className: 'error' }, errors.username) : null,
              e('label', null, 'Password',
                e('input', { type: 'password', value: password, onChange: (ev)=>setPassword(ev.target.value), placeholder: 'password' })
              ),
              errors.password ? e('div', { className: 'error' }, errors.password) : null,
              e('div', null,
                e('button', { type: 'submit', disabled: loading }, loading ? 'Logging in...' : 'Login'),
                e('button', { type: 'button', onClick: showProfile, style: { marginLeft: '8px' } }, 'Show Profile')
              )
            ),
            e('h3', null, 'Response'),
            e('pre', null, out)
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(LoginApp));
      })();
    </script>
  </body>
</html>
